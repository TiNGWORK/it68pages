<!DOCTYPE html><html lang="zh"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>不用三方包 给Laravel开启Swoole | IT乐吧</title><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/tingwork/it68pages@1.28/css/main.min.css"><link rel="icon" href="//img.alicdn.com/tfscom/TB1vwgAKFXXXXaIXVXXXXXXXXXX.png" type="image/x-icon"><link rel="shortcut icon" href="//img.alicdn.com/tfscom/TB1vwgAKFXXXXaIXVXXXXXXXXXX.png"><meta content="//img.alicdn.com/tfscom/TB1vwgAKFXXXXaIXVXXXXXXXXXX.png" itemprop="image"><link rel="icon" href="//cdn.jsdelivr.net/gh/tingwork/it68pages@1.27/img/it68.svg" type="image/svg+xml"><link rel="shortcut icon" href="//cdn.jsdelivr.net/gh/tingwork/it68pages@1.27/img/it68.svg" type="image/svg+xml"></head><body class="home-template home blog custom-background group-blog masthead-fixed list-view full-width footer-widgets grid"><div id="page" class="hfeed site"><div id="main" class="site-main"><a id="menuLink" href="javascript:void(0);" class="menu-link"><span></span></a><div id="main-content" class="main-content"><div id="secondary"><div style="position: fixed; top: 0px;" class="site_siderbar"><h2 class="site-description"><a href="/" rel="home" titl="IT乐吧 关注生活 关注互联网 关注每一天">IT乐吧</a></h2><div id="primary-sidebar" role="complementary" class="primary-sidebar widget-area"><aside id="nav_menu-2" class="widget widget_nav_menu"><div class="menu-container"><ul id="menu" class="menu"><li class="menu-item menu-item-current menu-item-type-custom menu-item-object-custom menu-item-home"><a href="/">首页</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href="javascript:void(0);">博文</a><ul class="sub-menu"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/">技术文章</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/site-anounce/">网站公告</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/daily/">生活笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/site-anounce/">网站公告</a></li></ul></ul></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href="/about">关于我</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href="/resume-of-xiaohuilam">简历</a></li></ul></div></aside><aside id="search-3" class="widget widget_search"><form role="search" method="get" action="/search" class="search-form"><label><span class="screen-reader-text">搜索：</span><input type="text" placeholder="搜索…" value="" name="q" title="搜索：" class="search-field"></label><input type="submit" value="" class="search-submit it68icon"></form></aside></div></div></div><div id="primary" class="content-area"><div id="content" role="main" class="site-content"><article data-article-id="16" class="post type-post status-publish format-aside has-post-thumbnail hentry has-post-thumbnail article-wrap"><header class="entry-header"><span class="author-image"><img alt="" height="42" src="https://cdn.jsdelivr.net/gh/tingwork/assets@0.02/image-1.jpeg" srcset="https://cdn.jsdelivr.net/gh/tingwork/assets@0.02/image-1.jpeg 1x, https://cdn.jsdelivr.net/gh/tingwork/assets@0.02/image-1.jpeg 2x" width="42" class="avatar avatar-42 photo avatar-default"></span><div class="article_title_infos"><h1 class="entry-title"><a href="">不用三方包 给Laravel开启Swoole</a></h1><div class="entry-meta"><span class="byline"><span class="author vcard"><a href="https://www.it68.com.cn/" rel="author" class="url fn n">蓝小灰 </a></span></span><span class="post-format"><span> </span><a href="/categories/tech/">技术文章</a><span> </span></span><span class="entry-date"><a href="" rel="bookmark"><time class="entry-date">2018-09-19</time></a></span></div></div></header><div class="entry-summary entry-content"><pre class="text-brand-wrap"><code class="text-brand serif">Laravel Swoole</code></pre><p><p><a href="https://swoole.com" target="_blank" rel="noopener">Swoole</a> 是一款优秀的 PHP 扩展，利用其可以实现原生 PHP 很难做到的常驻服务和异步。正好我有个 Laravel 项目可以折腾，就研究了下。</p>
<p>Laravel 项目是基于 composer 的，所以我先帖下我的 <code>composer.json</code> 中的 require 声明：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"require"</span>: &#123;</span><br><span class="line">        <span class="attr">"php"</span>: <span class="string">"^7.1.3"</span>,</span><br><span class="line">        <span class="attr">"cybercog/laravel-love"</span>: <span class="string">"^5.1"</span>,</span><br><span class="line">        <span class="attr">"dingo/api"</span>: <span class="string">"~v2.0.0-alpha2"</span>,</span><br><span class="line">        <span class="attr">"doctrine/dbal"</span>: <span class="string">"^2.8"</span>,</span><br><span class="line">        <span class="attr">"fideloper/proxy"</span>: <span class="string">"^4.0"</span>,</span><br><span class="line">        <span class="attr">"guzzlehttp/guzzle"</span>: <span class="string">"^6.3"</span>,</span><br><span class="line">        <span class="attr">"infyomlabs/adminlte-templates"</span>: <span class="string">"5.6.x-dev"</span>,</span><br><span class="line">        <span class="attr">"infyomlabs/laravel-generator"</span>: <span class="string">"5.6.x-dev"</span>,</span><br><span class="line">        <span class="attr">"jeroennoten/laravel-adminlte"</span>: <span class="string">"^1.23"</span>,</span><br><span class="line">        <span class="attr">"laravel/framework"</span>: <span class="string">"5.6.*"</span>,</span><br><span class="line">        <span class="attr">"laravel/tinker"</span>: <span class="string">"^1.0"</span>,</span><br><span class="line">        <span class="attr">"laravelcollective/html"</span>: <span class="string">"^5.6.0"</span>,</span><br><span class="line">        <span class="attr">"lshorz/luocaptcha"</span>: <span class="string">"^1.0"</span>,</span><br><span class="line">        <span class="attr">"overtrue/laravel-lang"</span>: <span class="string">"v3.0.08"</span>,</span><br><span class="line">        <span class="attr">"overtrue/laravel-wechat"</span>: <span class="string">"^4.0"</span>,</span><br><span class="line">        <span class="attr">"predis/predis"</span>: <span class="string">"^1.1"</span>,</span><br><span class="line">        <span class="attr">"spatie/laravel-permission"</span>: <span class="string">"^2.17"</span>,</span><br><span class="line">        <span class="attr">"tymon/jwt-auth"</span>: <span class="string">"~1.0.0-rc.2"</span>,</span><br><span class="line">        <span class="attr">"yajra/laravel-datatables-buttons"</span>: <span class="string">"^4.0"</span>,</span><br><span class="line">        <span class="attr">"yajra/laravel-datatables-oracle"</span>: <span class="string">"^8.7"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们要开启swoole，我们可选的包有这些：</p>
<ul>
<li><a href="https://github.com/swooletw/laravel-swoole" target="_blank" rel="noopener">swooletw/laravel-swoole</a></li>
<li><a href="https://github.com/hhxsv5/laravel-s" target="_blank" rel="noopener">hhxsv5/laravel-s</a></li>
</ul>
<p>但一般来说，项目中需要常驻容器的服务与每次均需重新构建的服务并不一样，所以我才剑走偏锋。</p>
<h4 id="起步"><a href="#起步" class="headerlink" title="起步"></a>起步</h4><p>我们需要将 <code>public/index.php</code> 替换成如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Response</span>;</span><br><span class="line"></span><br><span class="line">define(<span class="string">'LARAVEL_START'</span>, microtime(<span class="keyword">true</span>));</span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/../vendor/autoload.php'</span>;</span><br><span class="line">$app = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/../bootstrap/app.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Laravel</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Illuminate\Foundation\Application</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Foundation\Application</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $app;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * App\Http\Kernel</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \App\Http\Kernel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $kernel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * App\Http\Requests\Request</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \App\Http\Requests\Request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $request;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Illuminate\Http\JsonResponse</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Http\JsonResponse</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $response;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \Illuminate\Foundation\Application $app</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(\Illuminate\Foundation\Application $app)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;app = $app;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RUN</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        \Swoole\Runtime::enableCoroutine(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        $http = <span class="keyword">new</span> swoole_http_server(<span class="string">'127.0.0.1'</span>, <span class="string">'80'</span>);</span><br><span class="line"></span><br><span class="line">        $http-&gt;set([</span><br><span class="line">            <span class="string">'document_root'</span> =&gt; public_path(<span class="string">'/'</span>),</span><br><span class="line">            <span class="string">'enable_static_handler'</span> =&gt; <span class="keyword">true</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        $http-&gt;on(<span class="string">'request'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($req, $res)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                $kernel = <span class="keyword">$this</span>-&gt;app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">                $get = $req-&gt;get ?? [];</span><br><span class="line">                $post = $req-&gt;post ?? [];</span><br><span class="line">                $input = array_merge($get, $post);</span><br><span class="line">                $cookie = $req-&gt;cookie ?? [];</span><br><span class="line">                $files = $req-&gt;files ?? [];</span><br><span class="line">                $server = $req-&gt;server ?? [];</span><br><span class="line"></span><br><span class="line">                $request = Request::create($req-&gt;server[<span class="string">'request_uri'</span>], $req-&gt;server[<span class="string">'request_method'</span>], $input, $cookie, $files, $server);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>($req-&gt;header[<span class="string">'x-requested-with'</span>]) &amp;&amp; $req-&gt;header[<span class="string">'x-requested-with'</span>] == <span class="string">"XMLHttpRequest"</span>) &#123;</span><br><span class="line">                    $request-&gt;headers-&gt;set(<span class="string">'X-Requested-With'</span>, <span class="string">"XMLHttpRequest"</span>, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>($req-&gt;header[<span class="string">'accept'</span>]) &amp;&amp; $req-&gt;header[<span class="string">'accept'</span>]) &#123;</span><br><span class="line">                    $request-&gt;headers-&gt;set(<span class="string">'Accept'</span>, $req-&gt;header[<span class="string">'accept'</span>], <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $response = $kernel-&gt;handle($request);</span><br><span class="line"></span><br><span class="line">                $res-&gt;status($response-&gt;getStatusCode());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> ($response-&gt;headers-&gt;allPreserveCaseWithoutCookies() <span class="keyword">as</span> $name =&gt; $values) &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> ($values <span class="keyword">as</span> $value) &#123;</span><br><span class="line">                        $res-&gt;header($name, $value, <span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> ($response-&gt;headers-&gt;getCookies() <span class="keyword">as</span> $cookie) &#123;</span><br><span class="line">                    $res-&gt;header(<span class="string">'Set-Cookie'</span>, $cookie-&gt;getName() . strstr($cookie, <span class="string">'='</span>), <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                dump(time());</span><br><span class="line"></span><br><span class="line">                $res-&gt;end($response-&gt;getContent());</span><br><span class="line">                <span class="keyword">$this</span>-&gt;app-&gt;forgetInstance(<span class="string">'request'</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (\throwable $e) &#123;</span><br><span class="line">                <span class="keyword">echo</span> $e-&gt;getMessage();</span><br><span class="line">                <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">                <span class="keyword">echo</span> $e-&gt;getFile();</span><br><span class="line">                <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">                <span class="keyword">echo</span> $e-&gt;getLine();</span><br><span class="line">                <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        $http-&gt;start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> Laravel($app))-&gt;run();</span><br></pre></td></tr></table></figure></p>
<p>运行时发现大多数页面均没有问题，只有几个用了 <code>infyomlabs/laravel-generator</code> 产生的列表页，AJAX拉取JSON时却返回了HTML。</p>
<hr>
<h4 id="排查"><a href="#排查" class="headerlink" title="排查"></a>排查</h4><p>在有问题页面的 controller 代码中，找到如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Display a listing of the Star.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> StarDataTable $starDataTable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">(StarDataTable $starDataTable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $starDataTable-&gt;render(<span class="string">'stars.index'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>定位 <code>StarDataTable::render()</code> 到了<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Process dataTables needed render output.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $view</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $data</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $mergeData</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">($view, $data = [], $mergeData = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;request()-&gt;ajax() &amp;&amp; <span class="keyword">$this</span>-&gt;request()-&gt;wantsJson()) &#123;</span><br><span class="line">        <span class="keyword">return</span> app()-&gt;call([<span class="keyword">$this</span>, <span class="string">'ajax'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是判断 <code>$this-&gt;request()</code> 是不是 XHR 请求，且 <code>Accept</code> 请求头声明了 <code>application/json</code></p>
<p>而 <code>$this-&gt;request()</code> 实现如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get DataTables Request instance.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> \Yajra\DataTables\Utilities\Request</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">request</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;request ?: <span class="keyword">$this</span>-&gt;request = resolve(<span class="string">'datatables.request'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不难看出，如果第一次构建，会走到<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;request = resolve(<span class="string">'datatables.request'</span>);</span><br></pre></td></tr></table></figure></p>
<p>而 resolve 的实现是啥？<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (! function_exists(<span class="string">'resolve'</span>)) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Resolve a service from the container.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">resolve</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> app($name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>就是从容器中取出 <code>datatables.request</code> 的过程。</p>
<p>所以我们只需让每次请求结束，$app 容器忘掉 <code>datatables.request</code> 就好了</p>
<hr>
<h4 id="改进"><a href="#改进" class="headerlink" title="改进"></a>改进</h4><p>增加遗忘 <code>datatables.request</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$res-&gt;end($response-&gt;getContent());</span><br><span class="line"><span class="keyword">$this</span>-&gt;app-&gt;forgetInstance(<span class="string">'request'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;app-&gt;forgetInstance(<span class="string">'datatables.request'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;app-&gt;forgetInstance(\Dingo\Api\Http\Middleware\Request::class);</span><br></pre></td></tr></table></figure></p>
<p>完整最终版：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Response</span>;</span><br><span class="line"></span><br><span class="line">define(<span class="string">'LARAVEL_START'</span>, microtime(<span class="keyword">true</span>));</span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/../vendor/autoload.php'</span>;</span><br><span class="line">$app = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/../bootstrap/app.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Laravel</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Illuminate\Foundation\Application</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Foundation\Application</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $app;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * App\Http\Kernel</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \App\Http\Kernel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $kernel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * App\Http\Requests\Request</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \App\Http\Requests\Request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $request;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Illuminate\Http\JsonResponse</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Http\JsonResponse</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $response;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \Illuminate\Foundation\Application $app</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(\Illuminate\Foundation\Application $app)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;app = $app;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RUN</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        \Swoole\Runtime::enableCoroutine(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        $http = <span class="keyword">new</span> swoole_http_server(<span class="string">'127.0.0.1'</span>, <span class="string">'80'</span>);</span><br><span class="line"></span><br><span class="line">        $http-&gt;set([</span><br><span class="line">            <span class="string">'document_root'</span> =&gt; public_path(<span class="string">'/'</span>),</span><br><span class="line">            <span class="string">'enable_static_handler'</span> =&gt; <span class="keyword">true</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        $http-&gt;on(<span class="string">'request'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($req, $res)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                $kernel = <span class="keyword">$this</span>-&gt;app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">                $get = $req-&gt;get ?? [];</span><br><span class="line">                $post = $req-&gt;post ?? [];</span><br><span class="line">                $input = array_merge($get, $post);</span><br><span class="line">                $cookie = $req-&gt;cookie ?? [];</span><br><span class="line">                $files = $req-&gt;files ?? [];</span><br><span class="line">                $server = $req-&gt;server ?? [];</span><br><span class="line"></span><br><span class="line">                $request = Request::create($req-&gt;server[<span class="string">'request_uri'</span>], $req-&gt;server[<span class="string">'request_method'</span>], $input, $cookie, $files, $server);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>($req-&gt;header[<span class="string">'x-requested-with'</span>]) &amp;&amp; $req-&gt;header[<span class="string">'x-requested-with'</span>] == <span class="string">"XMLHttpRequest"</span>) &#123;</span><br><span class="line">                    $request-&gt;headers-&gt;set(<span class="string">'X-Requested-With'</span>, <span class="string">"XMLHttpRequest"</span>, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>($req-&gt;header[<span class="string">'accept'</span>]) &amp;&amp; $req-&gt;header[<span class="string">'accept'</span>]) &#123;</span><br><span class="line">                    $request-&gt;headers-&gt;set(<span class="string">'Accept'</span>, $req-&gt;header[<span class="string">'accept'</span>], <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $response = $kernel-&gt;handle($request);</span><br><span class="line"></span><br><span class="line">                $res-&gt;status($response-&gt;getStatusCode());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> ($response-&gt;headers-&gt;allPreserveCaseWithoutCookies() <span class="keyword">as</span> $name =&gt; $values) &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> ($values <span class="keyword">as</span> $value) &#123;</span><br><span class="line">                        $res-&gt;header($name, $value, <span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> ($response-&gt;headers-&gt;getCookies() <span class="keyword">as</span> $cookie) &#123;</span><br><span class="line">                    $res-&gt;header(<span class="string">'Set-Cookie'</span>, $cookie-&gt;getName() . strstr($cookie, <span class="string">'='</span>), <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                dump(time());</span><br><span class="line"></span><br><span class="line">                $res-&gt;end($response-&gt;getContent());</span><br><span class="line">                <span class="keyword">$this</span>-&gt;app-&gt;forgetInstance(<span class="string">'request'</span>);</span><br><span class="line">                <span class="comment">//$this-&gt;app-&gt;forgetInstance('session');</span></span><br><span class="line">                <span class="comment">//$this-&gt;app-&gt;forgetInstance('session.store');</span></span><br><span class="line">                <span class="comment">//$this-&gt;app-&gt;forgetInstance('cookie');</span></span><br><span class="line">                <span class="keyword">$this</span>-&gt;app-&gt;forgetInstance(<span class="string">'datatables.request'</span>);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;app-&gt;forgetInstance(\Dingo\Api\Http\Middleware\Request::class);</span><br><span class="line">                <span class="comment">//$kernel-&gt;terminate($request, $response);</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (\throwable $e) &#123;</span><br><span class="line">                <span class="keyword">echo</span> $e-&gt;getMessage();</span><br><span class="line">                <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">                <span class="keyword">echo</span> $e-&gt;getFile();</span><br><span class="line">                <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">                <span class="keyword">echo</span> $e-&gt;getLine();</span><br><span class="line">                <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        $http-&gt;start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> Laravel($app))-&gt;run();</span><br></pre></td></tr></table></figure></p>
<hr>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>比原生 laravel 确实快不少（这还有4句SQL查询）</p>
<p><img src="https://img.alicdn.com/imgextra/i3/665032476/O1CN011UA37OSPzKzZdGW_!!665032476.png" alt="测试截图"></p>
<hr>
<ul>
<li>注，此处给出的代码可以借鉴，但未经长期验证。且不同项目实际用到的包不同，需要在调试过程中 <code>debug</code> 容器中的服务提供者，和追踪代码来调优。</li>
</ul>
</p></div><div class="tags"></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'iamxiazi';
var disqus_identifier = '2018/09/19/make-swoolefy-laravel-without-packges/';
var disqus_title = '不用三方包 给Laravel开启Swoole';
var disqus_url = 'https://www.it68.com.cn/2018/09/19/make-swoolefy-laravel-without-packges/';
(function() {
 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
 dsq.src = 'https://disqus.oss-cn-shanghai.aliyuncs.com/embed.js';
 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
 })();</script><noscript id="dsq-count-scr" src="https://google-c.b0.upaiyun.com/count.js" async></noscript></div></article></div></div></div></div></div><script type="text/javascript" src="//cdn.jsdelivr.net/gh/jquery/jquery@1.12.1/dist/jquery.min.js"></script><footer id="colophon" name="#ft" role="contentinfo" class="site-footer"><div id="supplementary"><div id="footer-sidebar" role="complementary" class="footer-sidebar widget-area"><aside id="tag_cloud-2" class="widget widget_tag_cloud"><h1 class="widget-title">热门标签</h1><div class="tagcloud"><a class="category-link" href="/categories/tech/">技术文章</a><a class="category-link" href="/categories/tech/site-anounce/">网站公告</a><a class="category-link" href="/categories/daily/">生活笔记</a><a class="category-link" href="/categories/site-anounce/">网站公告</a></div></aside><aside id="friend_link-1" class="widget widget_tag_cloud"><h1 class="widget-title">友情链接</h1><div class="tagcloud"><a href="https://imququ.com/" target="_blank">JerryQu</a><a href="https://hexo.io" target="_blank">Hexo</a><a href="https://github.com/xiaohuilam/" target="_blank">Github</a></div></aside></div></div><div class="site-info">Copyright © <script type="text/javascript">document.writeln('2013~'+(new Date).getFullYear());</script> <span>Xiaohui Lam</span><span> All Rights Reserved.</span><span> Powered by</span><a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><p><span>Hosted by </span><a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p></div></footer></body></html>