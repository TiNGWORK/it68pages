<!DOCTYPE html><html lang="zh"><head><link rel="amphtml" href="./amp/index.html"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>NGINX简单配置 让SHA256证书支持XP SP1/SP2 | IT乐吧</title><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/tingwork/it68pages@1.0/css/main.css"><link rel="icon" href="//img.alicdn.com/tfscom/TB1vwgAKFXXXXaIXVXXXXXXXXXX.png" type="image/x-icon"><link rel="shortcut icon" href="//img.alicdn.com/tfscom/TB1vwgAKFXXXXaIXVXXXXXXXXXX.png"><meta content="//img.alicdn.com/tfscom/TB1vwgAKFXXXXaIXVXXXXXXXXXX.png" itemprop="image"></head><body class="home-template home blog custom-background group-blog masthead-fixed list-view full-width footer-widgets grid"><div id="page" class="hfeed site"><div id="main" class="site-main"><a id="menuLink" href="javascript:void(0);" class="menu-link"><span></span></a><div id="main-content" class="main-content"><div id="secondary"><div style="position: fixed; top: 0px;" class="site_siderbar"><h2 class="site-description"><a href="/" rel="home" titl="IT乐吧 关注生活 关注互联网 关注每一天">IT乐吧</a></h2><div id="primary-sidebar" role="complementary" class="primary-sidebar widget-area"><aside id="nav_menu-2" class="widget widget_nav_menu"><div class="menu-container"><ul id="menu" class="menu"><li class="menu-item menu-item-current menu-item-type-custom menu-item-object-custom menu-item-home"><a href="/">首页</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href="javascript:void(0);">博文</a><ul class="sub-menu"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/">技术文章</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/site-anounce/">网站公告</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/daily/">生活笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/site-anounce/">网站公告</a></li></ul></ul></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href="/about">关于我</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href="/resume-of-xiaohuilam">简历</a></li></ul></div></aside><aside id="search-3" class="widget widget_search"><form role="search" method="get" action="/search" class="search-form"><label><span class="screen-reader-text">搜索：</span><input type="text" placeholder="搜索…" value="" name="q" title="搜索：" class="search-field"></label><input type="submit" value="" class="search-submit it68icon"></form></aside></div></div></div><div id="primary" class="content-area"><div id="content" role="main" class="site-content"><article data-article-id="16" class="post type-post status-publish format-aside has-post-thumbnail hentry has-post-thumbnail article-wrap"><header class="entry-header"><span class="author-image"><img alt="" height="42" src="https://cdn.jsdelivr.net/gh/tingwork/assets@0.02/image-1.jpeg" srcset="https://cdn.jsdelivr.net/gh/tingwork/assets@0.02/image-1.jpeg 1x, https://cdn.jsdelivr.net/gh/tingwork/assets@0.02/image-1.jpeg 2x" width="42" class="avatar avatar-42 photo avatar-default"></span><div class="article_title_infos"><h1 class="entry-title"><a href="">NGINX简单配置 让SHA256证书支持XP SP1/SP2</a></h1><div class="entry-meta"><span class="byline"><span class="author vcard"><a href="https://www.it68.com.cn/" rel="author" class="url fn n">蓝小灰 </a></span></span><span class="post-format"><span> </span><a href="/categories/tech/">技术文章</a><span> </span></span><span class="entry-date"><a href="" rel="bookmark"><time class="entry-date">2015-08-06</time></a></span></div></div></header><div class="entry-summary entry-content"><pre class="text-brand-wrap"><code class="text-brand serif">SHA256 support IE6/7</code></pre><p><p>因为技术更新迭代的原因, XP的电脑上的IE6/IE7不支持sha256签名算法. 而XP用户在国内尚有约10%的市场占有率, 我们应该怎样才能让我们的网站https业务支持到XP呢?</p>
<p>##原理</p>
<p>在介绍方法之前, 给大家介绍下另外一个概念： SNI(<a href="https://en.wikipedia.org/wiki/ServerNameIndication" target="_blank" rel="external">https://en.wikipedia.org/wiki/ServerNameIndication</a>): 是用于让单个IP支持多个SSL证书配置的TLS协议扩展. 原理就是浏览器在TCP握手时将域名哈希信息和随机种子一起发送给服务器, 服务器根据域名去配置中寻找不同的SSL配置实现同IP多证书.<br>SNI并不是所有浏览器都支持的. SNI是05年以后陆续被各大系统和浏览器厂商加入到特性中的. 主流操作系统及浏览器市场兼容性如下:</p>
<table>
<thead>
<tr>
<th>浏览器</th>
<th>特性(SNI 支持)</th>
</tr>
</thead>
<tbody>
<tr>
<td>IE</td>
<td>7+ (Windows Vista+), (Windows XP/03及更早系统上任何版本IE浏览器均不支持SNI).</td>
</tr>
<tr>
<td>Firefox</td>
<td>2.0+</td>
</tr>
<tr>
<td>Opera</td>
<td>8.0+</td>
</tr>
<tr>
<td>Opera Mobile</td>
<td>10.1+ (Android)</td>
</tr>
<tr>
<td>Chrome</td>
<td>6+ (XP)</td>
</tr>
<tr>
<td>Chrome</td>
<td>5.0.342.1+ (OS X)</td>
</tr>
<tr>
<td>Safari</td>
<td>3.0+ (Mac OS X 10.5.6+, Windows Vista+)</td>
</tr>
<tr>
<td>Safari</td>
<td>(iOS 4.0+)</td>
</tr>
<tr>
<td>Android 默认浏览器</td>
<td>(Android 3.0+)</td>
</tr>
<tr>
<td>BlackBerry 默认浏览器</td>
<td>(BlackBerry 10+)</td>
</tr>
<tr>
<td>Windows Phone</td>
<td>7+</td>
</tr>
</tbody>
</table>
<p>可以看出, 已流行起来的现在代浏览器(Firefox, Chrome, Safari和Android/iOS浏览器)均早已支持SNI, 而XP上的IE6/IE7不支持SNI, IE6/IE7不认SHA256证书只认SHA1证书, 而且不会对SHA1证书出任何警告. 那么我们就可以用是否支持SNI来认定浏览器是否支持SHA256. 默认给SHA1证书, 支持SNI时给SHA256证书就行了.</p>
<p>我们正好可以利用SNI的此特性, 对支持SNI的现代化浏览器/系统提供SHA256以支持更安全的加密通信, 对不支持SNI的浏览器做SHA1证书以向下兼容. 即可达到SHA256+SHA1证书实现100%的浏览器市场占有率.</p>
<p>##成本</p>
<p>你需要多申请一份sha1算法的证书. 推荐使用WoSign(<a href="https://www.wosign.com/)提供的免费SSL证书" target="_blank" rel="external">https://www.wosign.com/)提供的免费SSL证书</a>. 申请时一定选择英文+sha1的.</p>
<p>##开始干</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">http&#123;  </div><div class="line">    ...</div><div class="line">    <span class="section">server</span> &#123;</div><div class="line">        <span class="attribute">server_name</span>                 xxx;  <span class="comment">#这儿不能写我网站的域名, 也就是www.it68.com.cn, 原因请自己想象</span></div><div class="line">        <span class="attribute">listen</span>                      <span class="number">443</span> ssl;</div><div class="line">        <span class="attribute">ssl</span>                         <span class="literal">on</span>;</div><div class="line">        <span class="attribute">ssl_certificate</span>             /home/ssl/it68_sha1.crt;</div><div class="line">        <span class="attribute">ssl_certificate_key</span>         /home/ssl/it68_sha1.pem;</div><div class="line">        <span class="attribute">ssl_protocols</span>               SSLv3 TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>; <span class="comment">#IE6只支持SSLv3, 若要用此方式必需启用...</span></div><div class="line">        <span class="attribute">ssl_session_cache</span>           shared:SSL:<span class="number">10m</span>;</div><div class="line">        <span class="attribute">ssl_session_timeout</span>         <span class="number">10m</span>;</div><div class="line"></div><div class="line">        <span class="attribute">location</span> / &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="section">server</span> &#123;</div><div class="line">        <span class="attribute">server_name</span>                 <span class="regexp">*.it</span>68.com.cn;</div><div class="line">        <span class="attribute">listen</span>                      <span class="number">443</span> ssl spdy;</div><div class="line">        <span class="attribute">ssl</span>                         <span class="literal">on</span>;</div><div class="line">        <span class="attribute">ssl_certificate</span>             /home/ssl/it68_sha256.crt;</div><div class="line">        <span class="attribute">ssl_certificate_key</span>         /home/ssl/it68_sha256.pem;</div><div class="line">        <span class="attribute">ssl_prefer_server_ciphers</span>   <span class="literal">on</span>;</div><div class="line">        <span class="attribute">ssl_ciphers</span>                 ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;</div><div class="line">        <span class="attribute">ssl_protocols</span>               TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</div><div class="line">        <span class="attribute">ssl_session_cache</span>           shared:SSL:<span class="number">10m</span>;</div><div class="line">        <span class="attribute">ssl_session_timeout</span>         <span class="number">10m</span>;</div><div class="line">        <span class="attribute">ssl_stapling</span>                <span class="literal">on</span>;</div><div class="line">        <span class="attribute">spdy_headers_comp</span>           <span class="number">9</span>;</div><div class="line"></div><div class="line">        <span class="attribute">location</span> / &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##运行效果</p>
<p>IE6/IE7<br><img src="https://img.alicdn.com/tfscom/TB1D91_IVXXXXb8XVXXXXXXXXXX.png" alt="ie"></p>
<p>现代浏览器<br><img src="https://img.alicdn.com/tfscom/TB1k9PkIVXXXXaGXpXXXXXXXXXX.png" alt="new"></p>
<p>##后话<br>如果您不懂技术又想占有更全的浏览器市场, 欢迎联系我帮您配置, 收费100元/台服务器. 微信: xiaohuilam1992.</p>
</p></div><div class="tags"></div></article></div></div></div></div></div><script type="text/javascript" src="//cdn.jsdelivr.net/gh/jquery/jquery@1.12.1/dist/jquery.min.js"></script><footer id="colophon" name="#ft" role="contentinfo" class="site-footer"><div id="supplementary"><div id="footer-sidebar" role="complementary" class="footer-sidebar widget-area"><aside id="tag_cloud-2" class="widget widget_tag_cloud"><h1 class="widget-title">热门标签</h1><div class="tagcloud"><a class="category-link" href="/categories/tech/">技术文章</a><a class="category-link" href="/categories/tech/site-anounce/">网站公告</a><a class="category-link" href="/categories/daily/">生活笔记</a><a class="category-link" href="/categories/site-anounce/">网站公告</a></div></aside><aside id="friend_link-1" class="widget widget_tag_cloud"><h1 class="widget-title">友情链接</h1><div class="tagcloud"><a href="https://imququ.com/" target="_blank">JerryQu</a><a href="https://hexo.io" target="_blank">Hexo</a><a href="https://github.com/xiaohuilam/" target="_blank">Github</a></div></aside></div></div><div class="site-info">Copyright © <script type="text/javascript">document.writeln('2013~'+(new Date).getFullYear());</script> <span>Xiaohui Lam</span><span> All Rights Reserved.</span><span> Powered by</span><a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><p><span>Hosted by </span><a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p></div></footer></body></html>